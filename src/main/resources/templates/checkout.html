<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Braintree Checkout</title>
  <style>
    body { display:flex; flex-direction:column;
           align-items:center; justify-content:center;
           height:100vh; margin:0; }
    #dropin-container { margin-bottom:1rem; }
    #message { margin-top:1rem; font-weight:bold; }
  </style>
</head>
<body>

  <!-- Injected by Thymeleaf -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    const USER_ID      = /*[[${userId}]]*/ 'unknown';
    const INITIAL_TYPE = /*[['${paymentType}']]*/ 'verify';
    const INITIAL_AMOUNT = /*[['${amount}']]*/ '10.00';
    const INITIAL_TARGET = /*[['${targetId}']]*/ null;
    /*]]>*/
  </script>

  <label>
    Amount:
    <input type="text" id="amount" th:value="${amount}">
  </label>
  <label>
    Type:
    <select id="paymentType">
      <option th:selected="${paymentType=='verify'}" value="verify">Verify User</option>
      <option th:selected="${paymentType=='addUser'}" value="addUser">Add Contact</option>
    </select>
  </label>
  <label id="target-group" th:style="${paymentType=='addUser'}? 'display:block' : 'display:none'">
    Target ID:
    <input type="text" id="targetId" th:value="${targetId}">
  </label>

  <div id="dropin-container"></div>
  <button id="pay-button">Pay</button>
  <div id="message"></div>

  <script src="https://js.braintreegateway.com/web/dropin/1.44.0/js/dropin.min.js"></script>
  <script>
    // Show/hide targetId field on change
    document.querySelector('#paymentType').addEventListener('change', e => {
      document.querySelector('#target-group').style.display =
        e.target.value === 'addUser' ? 'block' : 'none';
    });

    // 1️⃣ fetch token
    fetch(`/payments/client_token?userId=${USER_ID}`)
      .then(r => r.text())
      .then(token => new Promise((res, rej) => {
        braintree.dropin.create({
          authorization: token,
          container: '#dropin-container'
        }, (err, instance) => err ? rej(err) : res(instance));
      }))
      .then(dropinInstance => {
        document.querySelector('#pay-button').addEventListener('click', () => {
          dropinInstance.requestPaymentMethod((err, payload) => {
            if (err) {
              document.querySelector('#message').textContent =
                'Error: ' + err;
              return;
            }
            const body = {
              userId: USER_ID,
              nonce: payload.nonce,
              amount: document.querySelector('#amount').value,
              paymentType: document.querySelector('#paymentType').value,
              targetId: document.querySelector('#targetId').value || null
            };
            fetch('/payments/checkout', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            })
            .then(r => r.text())
            .then(msg => {
              document.querySelector('#message').textContent = msg;
            })
            .catch(e => {
              document.querySelector('#message').textContent =
                'Payment error: ' + e;
            });
          });
        });
      })
      .catch(e => {
        document.querySelector('#message').textContent =
          'Drop-in error: ' + e;
      });
  </script>

</body>
</html>
